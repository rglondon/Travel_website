<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supabase Connection Test</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'IBM Plex Mono', monospace; background: #FAFAFA; padding: 40px; }
    .container { max-width: 800px; margin: 0 auto; }
    h1 { font-size: 24px; margin-bottom: 24px; }
    .card { background: #FFF; border: 1px solid #E5E5E5; padding: 24px; margin-bottom: 16px; }
    .success { background: #D4EDDA; border-color: #C3E6CB; color: #155724; }
    .error { background: #F8D7DA; border-color: #F5C6CB; color: #721C24; }
    .pending { background: #FFF3CD; border-color: #FFEEBA; color: #856404; }
    pre { background: #1A1A1A; color: #FAFAFA; padding: 16px; font-size: 11px; overflow-x: auto; border-radius: 4px; }
    button { padding: 12px 24px; background: #1A1A1A; color: #FFF; border: none; cursor: pointer; font-family: inherit; font-size: 12px; margin-right: 8px; }
    button:hover { background: #333; }
    .btn-test { background: #0066FF; }
    .btn-test:hover { background: #0052CC; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîß Supabase Connection Test</h1>
    
    <div class="card" id="env-card">
      <h3>1. Environment Variables</h3>
      <p>Checking if environment variables are loaded...</p>
    </div>

    <div class="card" id="cors-card">
      <h3>2. CORS Pre-flight Check</h3>
      <p>Testing if browser can make requests to Supabase...</p>
      <button class="btn-test" onclick="testCORS()">Test CORS</button>
      <div id="cors-result" style="margin-top: 16px;"></div>
    </div>

    <div class="card" id="api-card">
      <h3>3. REST API Test</h3>
      <p>Testing direct REST API call to Supabase...</p>
      <button class="btn-test" onclick="testAPI()">Test API</button>
      <div id="api-result" style="margin-top: 16px;"></div>
    </div>

    <div class="card" id="galleries-card">
      <h3>4. Fetch Galleries</h3>
      <p>Fetching galleries from Supabase...</p>
      <button class="btn-test" onclick="fetchGalleries()">Fetch Galleries</button>
      <div id="galleries-result" style="margin-top: 16px;"></div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://erhvmlxdcplrhmmuboxo.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_Lt7xsPkx9HGvh_udcekpxw_CmnP_zI4';

    function log(elementId, status, message) {
      const el = document.getElementById(elementId);
      el.className = `card ${status}`;
      el.innerHTML = `<h3>${el.querySelector('h3').outerHTML}</h3><p>${message}</p>` + (el.querySelector('button') ? el.querySelector('button').outerHTML : '') + `<div id="${elementId.replace('-card', '-result')}" style="margin-top: 16px;"></div>`;
    }

    function logResult(elementId, message, isJson = false) {
      const el = document.getElementById(elementId);
      if (isJson) {
        el.innerHTML = `<pre>${JSON.stringify(message, null, 2)}</pre>`;
      } else {
        el.innerHTML = message;
      }
    }

    // 1. Check environment
    document.addEventListener('DOMContentLoaded', () => {
      const envCard = document.getElementById('env-card');
      const url = import.meta.env?.VITE_SUPABASE_URL;
      const key = import.meta.env?.VITE_SUPABASE_ANON_KEY;
      
      if (url && key) {
        envCard.className = 'card success';
        envCard.innerHTML = `<h3>1. Environment Variables</h3><p>‚úÖ VITE_SUPABASE_URL: ${url}</p><p>‚úÖ VITE_SUPABASE_ANON_KEY: ${key.substring(0, 20)}...</p>`;
      } else {
        envCard.className = 'card error';
        envCard.innerHTML = `<h3>1. Environment Variables</h3><p>‚ùå Missing environment variables</p><p>URL: ${url || 'NOT SET'}</p><p>Key: ${key ? 'SET' : 'NOT SET'}</p>`;
      }
    });

    // 2. Test CORS
    async function testCORS() {
      logResult('cors-result', 'Testing...');
      
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/`, {
          method: 'OPTIONS',
          headers: {
            'Origin': window.location.origin,
            'Access-Control-Request-Method': 'GET',
            'Access-Control-Request-Headers': 'authorization, apikey',
          },
        });
        
        const hasCORS = response.headers.get('Access-Control-Allow-Origin');
        if (hasCORS) {
          log('cors-card', 'success', `‚úÖ CORS is enabled! Allowed origin: ${hasCORS}`);
        } else {
          log('cors-card', 'error', '‚ö†Ô∏è CORS headers not found in OPTIONS response');
          logResult('cors-result', 'This might still work - checking GET request...');
        }
      } catch (error) {
        log('cors-card', 'error', `‚ùå CORS test failed: ${error.message}`);
      }
    }

    // 3. Test API
    async function testAPI() {
      logResult('api-result', 'Testing direct API call...');
      
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/`, {
          method: 'GET',
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
          },
        });
        
        log('api-card', response.ok ? 'success' : 'error', `Response status: ${response.status} ${response.statusText}`);
        
        const data = await response.json().catch(() => ({}));
        logResult('api-result', data, true);
      } catch (error) {
        log('api-card', 'error', `‚ùå API test failed: ${error.message}`);
      }
    }

    // 4. Fetch Galleries
    async function fetchGalleries() {
      logResult('galleries-result', 'Fetching galleries...');
      
      try {
        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/galleries?is_active=eq.true&order=created_at.desc`,
          {
            method: 'GET',
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`,
              'Content-Type': 'application/json',
              'Accept': 'application/json',
            },
          }
        );
        
        if (response.ok) {
          const data = await response.json();
          log('galleries-card', 'success', `‚úÖ Found ${data.length} galleries!`);
          logResult('galleries-result', data, true);
        } else {
          const errorText = await response.text();
          log('galleries-card', 'error', `‚ùå Error: ${response.status} ${response.statusText}`);
          logResult('galleries-result', errorText);
        }
      } catch (error) {
        log('galleries-card', 'error', `‚ùå Fetch failed: ${error.message}`);
      }
    }
  </script>
</body>
</html>
